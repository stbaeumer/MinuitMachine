@page "/apitest"
@inject CredentialStore Credentials
@inject ApiClient Api
@inject LocalStorageService Storage
@inject NavigationManager Navigation
@inject AppState AppState
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.Text.RegularExpressions

<h2>Verbindung herstellen</h2>

<div>
  <label>Server-IP</label>
  <input style="width:100%" value="@ServerIp" @oninput="OnIpInput" placeholder="192.168.134.142:8443" />

  <label>API Basis-URL (z.B. https://svwsserver:8443)</label>
  <input style="width:100%" value="@BaseUrl" @oninput="OnBaseUrlInput" placeholder="https://svwsserver:8443" />

  <label>Benutzername</label>
  <input style="width:100%" value="@(Credentials?.Username ?? "")" @oninput="OnUsernameInput" placeholder="Admin" />

  <label>Passwort</label>
  <input style="width:100%" type="password" value="@(Credentials?.Password ?? "")" @oninput="OnPasswordInput" />

  <label>Swagger JSON-Pfad</label>
  <input style="width:100%" value="@SwaggerPath" @oninput="OnSwaggerPathInput" placeholder="/openapi/server.json" />

  <label>Test-Endpunkt (relativer Pfad)</label>
  <input style="width:100%" value="@TestPath" @oninput="OnTestPathInput" placeholder="/db/svwsdb/schule/logo" />

  <label>Schema (z.B. svwsdb)</label>
  <input style="width:100%" value="@Schema" @oninput="OnSchemaInput" placeholder="svwsdb" />

  <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
    <button class="primary" @onclick="TestPing">Speichern und Verbindung testen</button>
    @if (ConnectionStatus == ConnectionResult.Success)
    {
      <span style="color:green;font-size:1.5rem;font-weight:bold;">✓</span>
    }
    else if (ConnectionStatus == ConnectionResult.Failed)
    {
      <span style="color:red;font-size:1.5rem;font-weight:bold;">✗</span>
    }
  </div>
</div>

@if (ConnectionStatus == ConnectionResult.Failed && !string.IsNullOrWhiteSpace(ErrorMessage))
{
  <div style="margin-top:1rem;padding:1rem;background:#ffe6e6;border:1px solid #ff0000;border-radius:6px;">
    <p style="margin:0;color:#cc0000;font-weight:bold;">@ErrorMessage</p>
  </div>
}

@code {
  private enum ConnectionResult { None, Success, Failed }
  
  private string SwaggerPath = "/openapi/server.json";
  private string TestPath = "/db/svwsdb/schule/logo";
  private string Schema = "svwsdb";
  private ConnectionResult ConnectionStatus = ConnectionResult.None;
  private string? ErrorMessage;
  private string ServerIp = "localhost:8443";
  private string BaseUrl = "https://localhost:8443";

  private const string KeyServerIp = "serverIp";
  private const string KeyBaseUrl = "baseUrl";
  private const string KeyUsername = "username";
  private const string KeyPassword = "password";
  private const string KeySwaggerPath = "swaggerPath";
  private const string KeyTestPath = "testPath";
  private const string KeySchema = "schema";

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;
    
    var storedIp = await Storage.GetItemAsync(KeyServerIp);
    if (!string.IsNullOrWhiteSpace(storedIp))
    {
      ServerIp = storedIp!;
    }

    var storedBase = await Storage.GetItemAsync(KeyBaseUrl);
    if (!string.IsNullOrWhiteSpace(storedBase))
    {
      BaseUrl = storedBase!;
    }

    if (!string.IsNullOrWhiteSpace(BaseUrl) && Credentials != null)
    {
      Credentials.BaseUrl = BaseUrl;
    }

    var storedUsername = await Storage.GetItemAsync(KeyUsername);
    if (!string.IsNullOrWhiteSpace(storedUsername) && Credentials != null)
    {
      Credentials.Username = storedUsername!;
    }
    else if (Credentials != null && string.IsNullOrWhiteSpace(Credentials.Username))
    {
      Credentials.Username = "Admin";
    }

    var storedPassword = await Storage.GetItemAsync(KeyPassword);
    if (!string.IsNullOrWhiteSpace(storedPassword) && Credentials != null)
    {
      Credentials.Password = storedPassword!;
    }

    var storedSwaggerPath = await Storage.GetItemAsync(KeySwaggerPath);
    if (!string.IsNullOrWhiteSpace(storedSwaggerPath))
    {
      SwaggerPath = storedSwaggerPath!;
    }

    var storedTestPath = await Storage.GetItemAsync(KeyTestPath);
    if (!string.IsNullOrWhiteSpace(storedTestPath))
    {
      TestPath = storedTestPath!;
    }

    var storedSchema = await Storage.GetItemAsync(KeySchema);
    if (!string.IsNullOrWhiteSpace(storedSchema))
    {
      Schema = storedSchema!;
    }

    StateHasChanged();
  }

  private async Task TestPing()
  {
    ConnectionStatus = ConnectionResult.None;
    ErrorMessage = null;
    if (Credentials == null)
    {
      ConnectionStatus = ConnectionResult.Failed;
      ErrorMessage = "Fehler: Zugangsdaten nicht verfügbar.";
      return;
    }
    
    try
    {
      // If user entered a placeholder token like {schema} or accidentally encoded %7B...%7D, replace any {...} with the configured Schema
      var effectiveTestPath = TestPath ?? string.Empty;

      // If the user or browser encoded braces, decode percent-encoded braces first
      if (effectiveTestPath.Contains("%7B", StringComparison.OrdinalIgnoreCase) || effectiveTestPath.Contains("%7D", StringComparison.OrdinalIgnoreCase))
      {
        effectiveTestPath = effectiveTestPath.Replace("%7B", "{", StringComparison.OrdinalIgnoreCase).Replace("%7D", "}", StringComparison.OrdinalIgnoreCase);
      }

      // Also unescape other encodings just in case (won't change already-correct paths)
      try
      {
        var unescaped = Uri.UnescapeDataString(effectiveTestPath);
        if (!string.IsNullOrEmpty(unescaped)) effectiveTestPath = unescaped;
      }
      catch { /* ignore */ }

      if (effectiveTestPath.Contains('{'))
      {
        effectiveTestPath = Regex.Replace(effectiveTestPath, "\\{[^}]*\\}", Schema);
      }

      var finalUrl = Combine(Credentials.BaseUrl, effectiveTestPath);
      await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: calling URL:", finalUrl, "effectiveTestPath:", effectiveTestPath });

      var (status, text) = await Api.GetTextAsync(finalUrl);
      
      if (status.StartsWith("200"))
      {
        ConnectionStatus = ConnectionResult.Success;
        // Logo abrufen and save to storage if available
        // compute logo path using schema placeholder
        var logoPathTemplate = "/db/{schema}/schule/logo";
        var logoPath = logoPathTemplate;
        if (logoPath.Contains('{'))
        {
          logoPath = Regex.Replace(logoPath, "\\{[^}]*\\}", Schema);
        }
        var finalLogoUrl = Combine(Credentials.BaseUrl, logoPath);
        await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: logo URL:", finalLogoUrl });
        var (logoStatus, logoBase64) = await Api.GetTextAsync(finalLogoUrl);
        if (logoStatus.StartsWith("200") && !string.IsNullOrWhiteSpace(logoBase64))
        {
          await Storage.SetItemAsync("schullogo", logoBase64.Trim('"'));
        }

        // Persist connected flag and notify global state so layout can update
        await Storage.SetItemAsync("connected", "true");
        await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: notifying connected=true" });
        AppState.NotifyConnectionChanged(true);
      }
      else if (status.StartsWith("401"))
      {
        ConnectionStatus = ConnectionResult.Failed;
        ErrorMessage = "Fehler: Anmeldung fehlgeschlagen. Bitte prüfen Sie Benutzername und Passwort.";
        await Storage.SetItemAsync("connected", "false");
        await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: notifying connected=false (401)" });
        AppState.NotifyConnectionChanged(false);
      }
      else if (status.StartsWith("404"))
      {
        ConnectionStatus = ConnectionResult.Failed;
        ErrorMessage = "Fehler: Server-Endpunkt nicht gefunden. Bitte prüfen Sie die API Basis-URL.";
        await Storage.SetItemAsync("connected", "false");
        await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: notifying connected=false (404)" });
        AppState.NotifyConnectionChanged(false);
      }
      else
      {
        ConnectionStatus = ConnectionResult.Failed;
        ErrorMessage = $"Fehler: Server antwortete mit Status {status}.";
        await Storage.SetItemAsync("connected", "false");
        await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: notifying connected=false (other)" });
        AppState.NotifyConnectionChanged(false);
      }
    }
    catch (Exception ex)
    {
      ConnectionStatus = ConnectionResult.Failed;
      if (ex.Message.Contains("Failed to fetch"))
      {
        ErrorMessage = "Fehler: Verbindung zum Server fehlgeschlagen. Bitte prüfen Sie die Server-IP und stellen Sie sicher, dass das SSL-Zertifikat akzeptiert wurde.";
      }
      else
      {
        ErrorMessage = $"Fehler: {ex.Message}";
      }
      await Storage.SetItemAsync("connected", "false");
      await JS.InvokeAsync<object>("console.log", new object[] { "ApiTest: notifying connected=false (exception) - " + ex.Message });
      AppState.NotifyConnectionChanged(false);
    }
  }

  private static string Combine(string? baseUrl, string? relative)
  {
    baseUrl = (baseUrl ?? string.Empty).TrimEnd('/');
    relative = string.IsNullOrWhiteSpace(relative) ? string.Empty : relative.TrimStart('/');
    return string.IsNullOrWhiteSpace(baseUrl) ? $"/{relative}" : $"{baseUrl}/{relative}";
  }

  private async Task OnIpInput(ChangeEventArgs e)
  {
    ServerIp = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeyServerIp, ServerIp);
    if (!string.IsNullOrWhiteSpace(ServerIp))
    {
      var ip = ServerIp;
      if (!ip.Contains(':'))
      {
        ip = $"{ip}:8443";
      }
      BaseUrl = $"https://{ip}";
      await Storage.SetItemAsync(KeyBaseUrl, BaseUrl);
      if (Credentials != null)
      {
        Credentials.BaseUrl = BaseUrl;
      }
      StateHasChanged();
    }
  }

  private async Task OnBaseUrlInput(ChangeEventArgs e)
  {
    BaseUrl = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeyBaseUrl, BaseUrl);
    if (Credentials != null)
    {
      Credentials.BaseUrl = BaseUrl;
    }
  }

  private async Task OnUsernameInput(ChangeEventArgs e)
  {
    if (Credentials == null) return;
    Credentials.Username = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeyUsername, Credentials.Username);
  }

  private async Task OnPasswordInput(ChangeEventArgs e)
  {
    if (Credentials == null) return;
    Credentials.Password = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeyPassword, Credentials.Password);
  }

  private async Task OnSwaggerPathInput(ChangeEventArgs e)
  {
    SwaggerPath = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeySwaggerPath, SwaggerPath);
  }

  private async Task OnTestPathInput(ChangeEventArgs e)
  {
    TestPath = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeyTestPath, TestPath);
  }

  private async Task OnSchemaInput(ChangeEventArgs e)
  {
    Schema = e.Value?.ToString() ?? string.Empty;
    await Storage.SetItemAsync(KeySchema, Schema);
  }
}
