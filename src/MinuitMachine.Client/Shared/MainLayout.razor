@inherits LayoutComponentBase
@inject LocalStorageService Storage
@inject ApiClient Api
@inject CredentialStore Credentials

<header class="app-header">
  <div style="display:flex;align-items:center;justify-content:center;gap:1rem;">
    <img src="minuitmachine.png" alt="Logo" style="height:2.5rem;" />
    <h1>Minuit Machine</h1>
  </div>
  <nav>
    <a href="/" title="Home">üè†</a>
    <a href="/apitest">Verbindung herstellen</a>
  </nav>
  <div style="position:absolute;top:1rem;right:1rem;">
    @if (!string.IsNullOrEmpty(SchullogoBase64))
    {
      <img src="@SchullogoBase64" alt="Schullogo" style="max-height:48px;max-width:120px;border-radius:4px;box-shadow:0 0 4px #888;" />
    }
  </div>
</header>

<div class="status-bar">
  <span>Sch√ºler: @SchuelerAnzahl</span>
</div>

<main>
  @Body
</main>

<footer class="app-footer">
  <p>&copy; @DateTime.Now.Year Stefan B√§umer</p>
</footer>

@code {
  private string? SchullogoBase64;
  private string SchuelerAnzahl = "-";
  private const string KeySchullogo = "schullogo";

  protected override async Task OnInitializedAsync()
  {
    var logo = await Storage.GetItemAsync(KeySchullogo);
    if (!string.IsNullOrWhiteSpace(logo))
    {
      var trimmedLogo = logo.Replace("\"", "");
      SchullogoBase64 = "data:image/jpeg;base64," + trimmedLogo;
    }
    
    // Lade Credentials aus LocalStorage
    if (Credentials != null)
    {
      var storedBase = await Storage.GetItemAsync("baseUrl");
      if (!string.IsNullOrWhiteSpace(storedBase))
      {
        Credentials.BaseUrl = storedBase!;
      }

      var storedUsername = await Storage.GetItemAsync("username");
      if (!string.IsNullOrWhiteSpace(storedUsername))
      {
        Credentials.Username = storedUsername!;
      }

      var storedPassword = await Storage.GetItemAsync("password");
      if (!string.IsNullOrWhiteSpace(storedPassword))
      {
        Credentials.Password = storedPassword!;
      }
      
      // Jetzt erst Sch√ºleranzahl laden, nachdem Credentials gesetzt sind
      await LoadSchuelerAnzahl();
    }
  }

  private async Task LoadSchuelerAnzahl()
  {
    try
    {
      if (Credentials == null || string.IsNullOrWhiteSpace(Credentials.BaseUrl))
      {
        SchuelerAnzahl = "Keine Verbindung";
        return;
      }
      
      // Aktuellen Abschnitt ermitteln (verwenden wir erstmal 0 f√ºr aktuell)
      var url = $"{Credentials.BaseUrl}/db/svwsdb/schueler/abschnitt/0/auswahlliste";
      var (status, jsonText) = await Api.GetTextAsync(url);
      
      if (status.StartsWith("200") && !string.IsNullOrWhiteSpace(jsonText))
      {
        // JSON parsen - es ist ein Array, z√§hle die "id"-Vorkommen
        var pattern = "\"id\"";
        var count = (jsonText.Length - jsonText.Replace(pattern, "").Length) / pattern.Length;
        SchuelerAnzahl = count.ToString();
        StateHasChanged();
      }
      else
      {
        SchuelerAnzahl = $"Fehler {status}";
      }
    }
    catch (Exception ex)
    {
      SchuelerAnzahl = $"Fehler: {ex.Message}";
    }
  }
}
